---
import Layout from '../layouts/Layout.astro';
import ContextAlert from '../components/ContextAlert.astro';
import Markdown from '../components/Markdown.astro';

const explainer = `
Tap the button below to share your exact GPS location with our dispatch team.
Your phone will ask for permission. Please choose **Allow**.
`;
---

<Layout title="Share your location">
  <ContextAlert class="mb-8" />
  <h1 class="mb-6">TR Mechanics ‚Äì Share My Location</h1>
  <Markdown content={explainer} class="mb-6 text-lg" />

  <div class="flex gap-4 items-center mb-6">
    <button id="shareBtn" class="btn btn-lg sm:min-w-64">üìç Share My Location</button>
    <span id="status" class="text-sm opacity-80"></span>
  </div>

  <pre id="debug" class="p-3 rounded-md bg-neutral-100 text-sm overflow-x-auto" style="display:none"></pre>

  <p class="mt-6">
    Having trouble? Make sure Location/GPS is enabled on your phone, then try again.
  </p>

  <script>
    // ‚úÖ Your real Slack webhook
    const SLACK_WEBHOOK = "https://hooks.slack.com/services/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";

    const btn = document.getElementById('shareBtn');
    const statusEl = document.getElementById('status');
    const debugEl = document.getElementById('debug');

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function qsp(name) {
      try { return new URL(window.location.href).searchParams.get(name) || ""; }
      catch { return ""; }
    }

    btn.addEventListener('click', async () => {
      if (!navigator.geolocation) {
        setStatus("This device doesn't support GPS.");
        return;
      }

      setStatus("Getting location‚Ä¶");

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = Math.round(pos.coords.accuracy || 0);
        const ts  = new Date().toISOString();
        const sid = qsp('sid'); // optional session id from Voiceflow link
        const maps = `https://maps.google.com/?q=${lat},${lng}`;

        const text =
`üìç *New Job Location*
*Lat/Lng:* ${lat}, ${lng} (¬±${acc} m)
*Map:* ${maps}
*Time:* ${ts}
*Ref:* ${sid || 'n/a'}`;

        try {
          const res = await fetch(SLACK_WEBHOOK, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ text })
          });

          if (!res.ok) throw new Error("Slack returned " + res.status);

          setStatus("‚úÖ Location sent to dispatch.");
          debugEl.style.display = 'block';
          debugEl.textContent = text;
        } catch (err) {
          setStatus("‚ùå Couldn't send to Slack. Please call us.");
          debugEl.style.display = 'block';
          debugEl.textContent = "Error: " + (err?.message || err);
        }
      }, (err) => {
        setStatus("Location error: " + err.message);
      }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    });
  </script>
</Layout>
